name: Build and Deploy to Azure

on:
  push:
    branches:
      - develop

env:
  DEV_APP_NAME: banking-app-dev-egcrc2h7g0aycuef.canadacentral-01
  DEV_RESOURCE_GROUP: banking-rg-dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn clean package
      
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: app
        path: target/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: app
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.DEV_APP_NAME }}
        package: '*.jar'
        
    - name: Configure App Settings
      uses: azure/appservice-settings@v1
      with:
        app-name: ${{ env.DEV_APP_NAME }}
        resource-group: ${{ env.DEV_RESOURCE_GROUP }}
        app-settings-json: |
          [
            {
              "name": "SPRING_PROFILES_ACTIVE",
              "value": "dev"
            },
            {
              "name": "MONGODB_URI",
              "value": "${{ secrets.DEV_MONGODB_URI }}"
            },
            {
              "name": "JWT_SECRET",
              "value": "${{ secrets.DEV_JWT_SECRET }}"
            }
          ]
